import{e as M,r as d,u as O,j as e,T as U,B as y}from"./index-AQOmLPA_.js";import{a as f}from"./api-wEynFWk2.js";import{C,b as z,c as E,a as I}from"./card-CJ0__Qs_.js";import{P as V}from"./progress-CcTMyZop.js";import{S as j}from"./skeleton-BuPLBBvy.js";function Q(){const{t:s}=M(),[o,B]=d.useState(null),[q,S]=d.useState(!1),[r,R]=d.useState("Z1"),[m,D]=d.useState(void 0),[$,Z]=d.useState([]),[T,P]=d.useState(!1),[p,v]=d.useState([]),[N,b]=d.useState(!1),[F,A]=d.useState(!0),{toast:x}=O(),h=r.trim().length>0,g=m!=null&&m>0,c=d.useCallback(async()=>{try{const[t,a,u]=await Promise.all([f.tankStatus("T1"),f.alerts(r,10),f.valveEvents(r,10)]);B(t),Z(a.items),v(u.items);const i=u.items.find(l=>l.action==="start"&&(l.status==="sent"||l.status==="queued")),n=u.items.find(l=>l.action==="stop"&&(l.status==="sent"||l.status==="queued"));b(!!i&&(!n||new Date(n.ts)<new Date(i.ts))),A(!1)}catch(t){console.error(t),A(!1)}},[r]);d.useEffect(()=>{c();const t=setInterval(c,15e3);return()=>clearInterval(t)},[c]);const _=d.useCallback(async(t=!1)=>{if(!h){x({title:"Zone required",description:"Please enter a zone id (e.g., Z1)",variant:"destructive"}),document.getElementById("zone")?.focus();return}if(!g){x({title:"Duration required",description:"Please set a positive duration in seconds",variant:"destructive"}),document.getElementById("duration")?.focus();return}S(!0);const a=p,u=N,i={ts:new Date().toISOString(),zone_id:r,action:"start",duration_s:m??0,status:"queued"};v([i,...p]),b(!0);try{const n=await f.irrigationStart(r,m,t);v(w=>w.map(k=>k===i?{...k,status:n.ok?"sent":"queued"}:k));const l=x({title:n.ok?"Irrigation queued":"Blocked",description:n.note||n.status,action:e.jsx(U,{altText:"Undo",onClick:async()=>{try{await f.irrigationStop(r),b(!1),v(w=>[{ts:new Date().toISOString(),zone_id:r,action:"stop",duration_s:0,status:"queued"},...w.filter(k=>k!==i)])}catch(w){console.error(w)}finally{c()}},children:"Undo"})});c()}catch(n){const l=n instanceof Error?n.message:String(n);x({title:"Failed",description:l,variant:"destructive"}),v(a),b(u)}finally{S(!1)}},[h,g,p,N,r,m,x,c]),L=d.useCallback(async()=>{S(!0);const t=p,a=N,u={ts:new Date().toISOString(),zone_id:r,action:"stop",duration_s:0,status:"queued"};v([u,...p]),b(!1);try{const i=await f.irrigationStop(r);v(n=>n.map(l=>l===u?{...l,status:i.ok?"sent":"queued"}:l)),x({title:i.ok?"Stop sent":"Stop queued",description:i.status}),c()}catch(i){const n=i instanceof Error?i.message:String(i);x({title:"Failed",description:n,variant:"destructive"}),v(t),b(a)}finally{S(!1)}},[p,N,r,x,c]);return d.useEffect(()=>{const t=a=>{const u=(document.activeElement?.tagName||"").toLowerCase();u==="input"||u==="textarea"||document.activeElement?.isContentEditable||(a.key==="r"?(a.preventDefault(),c()):a.key==="s"?(a.preventDefault(),h&&g?_(!1):(x({title:"Fix inputs",description:"Provide a zone and positive duration",variant:"destructive"}),(h?document.getElementById("duration"):document.getElementById("zone"))?.focus())):a.key==="x"&&(a.preventDefault(),L()))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[h,g,c,_,L,x]),e.jsxs("div",{className:"max-w-5xl mx-auto p-6 space-y-6",children:[e.jsxs(C,{role:"region","aria-labelledby":"tank-card-title",children:[e.jsx(z,{children:e.jsxs(E,{id:"tank-card-title",children:[s("tank")," ",s("status")]})}),e.jsx(I,{className:"space-y-3",children:F?e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{className:"h-6 w-24"}),e.jsx(j,{className:"h-4 w-40"}),e.jsx(j,{className:"h-4 w-32"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:s("tank")}),e.jsx("div",{className:"text-xl font-semibold",children:o?.tank_id??"T1"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:s("tank_level")}),e.jsx("div",{className:"text-xl font-semibold",children:o?.level_pct!=null?`${o.level_pct.toFixed(0)}%`:"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:s("tank_volume")}),e.jsx("div",{className:"text-xl font-semibold",children:o?.volume_l!=null?`${Math.round(o.volume_l)} L`:"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:s("updated")}),e.jsx("div",{className:"text-xl font-semibold",children:o?.last_update?new Date(o.last_update).toLocaleString():"—"})]}),e.jsx(y,{variant:"secondary","aria-label":"Refresh tank status (R)",onClick:c,children:s("refresh")})]}),e.jsxs("div",{children:[e.jsx(V,{value:o?.level_pct??0,className:`${(o?.level_pct??0)<20?"bg-red-100":(o?.level_pct??0)<50?"bg-yellow-100":"bg-green-100"}`}),e.jsx("div",{className:"text-xs mt-1 text-muted-foreground",children:(o?.level_pct??0)<20?s("low_level"):(o?.level_pct??0)<50?s("moderate"):s("healthy")})]})]})})]}),e.jsxs(C,{role:"region","aria-labelledby":"irrigation-card-title",children:[e.jsx(z,{children:e.jsxs(E,{id:"irrigation-card-title",children:[s("nav_irrigation")," ",s("status")]})}),e.jsxs(I,{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsx("label",{htmlFor:"zone",className:"text-sm",children:s("zone")}),h?e.jsx("input",{id:"zone",name:"zone",className:"border px-3 py-2 rounded-md",placeholder:"e.g., Z1",title:"Irrigation zone id",value:r,onChange:t=>R(t.target.value)}):e.jsx("input",{id:"zone",name:"zone",className:"border px-3 py-2 rounded-md border-red-600 focus:outline-red-600",placeholder:"e.g., Z1",title:"Irrigation zone id",value:r,onChange:t=>R(t.target.value),"aria-invalid":"true","aria-describedby":"zone-help"}),!h&&e.jsx("span",{id:"zone-help",className:"text-xs text-red-600",children:"Zone is required"}),e.jsx("label",{htmlFor:"duration",className:"text-sm",children:s("duration_seconds")}),e.jsxs("div",{className:"relative",children:[g?e.jsx("input",{id:"duration",name:"duration",type:"number",className:"border px-3 py-2 rounded-md w-32 pr-10",placeholder:"seconds",title:"Irrigation duration in seconds",value:m??"",onChange:t=>D(t.target.value?Math.max(0,Number(t.target.value)):void 0),min:0}):e.jsx("input",{id:"duration",name:"duration",type:"number",className:"border px-3 py-2 rounded-md w-32 pr-10 border-red-600 focus:outline-red-600",placeholder:"seconds",title:"Irrigation duration in seconds",value:m??"",onChange:t=>D(t.target.value?Math.max(0,Number(t.target.value)):void 0),min:0,"aria-invalid":"true","aria-describedby":"duration-help"}),e.jsx("span",{className:"absolute right-2 top-1/2 -translate-y-1/2 text-xs text-muted-foreground",children:"s"})]}),!g&&e.jsx("span",{id:"duration-help",className:"text-xs text-red-600",children:"Enter a positive number of seconds"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[s("quick"),": ",[60,120,300,600].map(t=>e.jsxs(y,{size:"sm",variant:"outline",onClick:()=>D(t),children:[t,"s"]},t))]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:m==null||m<=0?s("duration_seconds"):""}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(y,{"aria-label":"Start irrigation (S)",onClick:()=>_(!1),disabled:q||!g||!h,children:s("start")}),e.jsx(y,{"aria-label":"Stop irrigation (X)",variant:"destructive",onClick:L,disabled:q,children:s("stop")}),e.jsx(y,{"aria-label":"Force start irrigation",variant:"outline",onClick:()=>_(!0),disabled:q||!g||!h,children:s("force_start")}),e.jsxs("span",{role:"status","aria-live":"polite",className:`text-sm ${N?"text-green-600":"text-muted-foreground"}`,children:[s("status"),": ",s(N?"running":"idle")]})]})]})]}),e.jsxs(C,{role:"region","aria-labelledby":"events-card-title",children:[e.jsx(z,{children:e.jsx(E,{id:"events-card-title",children:s("recent_valve_events")})}),e.jsx(I,{children:F?e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{className:"h-4 w-64"}),e.jsx(j,{className:"h-4 w-56"}),e.jsx(j,{className:"h-4 w-48"})]}):p.length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:s("no_events")}):e.jsx("ul",{className:"space-y-2",role:"list","aria-label":"Recent valve events",children:p.map((t,a)=>e.jsxs("li",{role:"listitem",className:"flex items-center justify-between border rounded-md px-3 py-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:`px-2 py-0.5 rounded text-xs ${t.action==="start"?"bg-emerald-100 text-emerald-700":"bg-slate-100 text-slate-700"}`,children:t.action}),e.jsx("span",{className:"text-xs text-muted-foreground",children:t.duration_s?`${Math.round(t.duration_s)}s`:"—"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:t.status})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:new Date(t.ts).toLocaleString()})]},a))})})]}),e.jsxs(C,{role:"region","aria-labelledby":"alerts-card-title",children:[e.jsx(z,{children:e.jsxs(E,{id:"alerts-card-title",className:"flex items-center justify-between",children:[e.jsx("span",{children:s("alerts")}),e.jsxs("label",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx("input",{type:"checkbox",checked:T,onChange:t=>P(t.target.checked)}),s("show_acknowledged")]})]})}),e.jsx(I,{children:F?e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{className:"h-4 w-64"}),e.jsx(j,{className:"h-4 w-56"})]}):$.filter(t=>T||!t.sent).length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:s("all_clear")}):e.jsx("ul",{className:"space-y-2",role:"list","aria-label":"Alerts list",children:$.filter(t=>T||!t.sent).map((t,a)=>e.jsxs("li",{role:"listitem",className:`flex items-center justify-between border rounded-md px-3 py-2 ${t.sent?"opacity-60":""}`,children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:[t.category,t.sent?` • ${s("acknowledged")}`:""]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:t.message})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:t.ts?new Date(t.ts).toLocaleString():""}),!t.sent&&e.jsx(y,{size:"sm","aria-label":"Acknowledge alert",variant:"outline",onClick:async()=>{t.ts&&(await f.alertAck(t.ts),c())},children:s("acknowledge")})]})]},a))})})]})]})}export{Q as default};
