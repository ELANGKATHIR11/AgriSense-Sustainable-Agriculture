import{e as I,r as n,u as L,j as e,B as M}from"./index-AQOmLPA_.js";import{a as _}from"./api-wEynFWk2.js";import{C as p}from"./card-CJ0__Qs_.js";import{T as $,a as z,b as N,c as w}from"./tabs-Bc9hHVt6.js";import{S as O,a as R,b as V,c as B,d as E}from"./select-6AjSoAZR.js";function S({points:t,color:o="#16a34a"}){if(!t.length)return e.jsx("div",{className:"h-12"});const x=240,l=48,u=4,y=Math.min(...t),f=Math.max(...t)-y||1,j=(x-u*2)/Math.max(1,t.length-1),a=t.map((g,m)=>{const v=u+m*j,d=l-u-(g-y)/f*(l-u*2);return`${m===0?"M":"L"}${v},${d}`}).join(" ");return e.jsx("svg",{width:x,height:l,className:"overflow-visible",children:e.jsx("path",{d:a,fill:"none",stroke:o,strokeWidth:2})})}function D(){const{t}=I(),[o,x]=n.useState("Z1"),[l,u]=n.useState([]),[y,T]=n.useState(!0),[f,j]=n.useState(null),[a,g]=n.useState(null),[m,v]=n.useState(!1),{toast:d}=L();n.useEffect(()=>{let s=!0;const r=async()=>{try{const c=await _.recent(o,200);if(!s)return;u((c.items||[]).slice().reverse()),j(null)}catch(c){if(!s)return;j(c instanceof Error?c.message:String(c))}finally{s&&T(!1)}};r();const h=setInterval(r,5e3);return()=>{s=!1,clearInterval(h)}},[o]),n.useEffect(()=>{let s=!0;const r=async()=>{try{const c=await _.edgeHealth();if(!s)return;g(c.status==="ok")}catch{if(!s)return;g(!1)}};r();const h=setInterval(r,15e3);return()=>{s=!1,clearInterval(h)}},[]);const C=n.useRef(null);n.useEffect(()=>{a!==C.current&&(C.current!==null&&(a?d({title:t("edge_label")+" "+t("connected"),description:t("edge_label")+" "+t("available")}):a===!1&&d({title:t("edge_label")+" "+t("unavailable"),description:t("edge_label")+" "+t("not_detected")})),C.current=a)},[a,d,t]);const k=async()=>{v(!0);try{const s=await _.edgeCapture(o);d({title:"Capture complete",description:`Water: ${s.recommendation.water_liters.toFixed?.(1)??s.recommendation.water_liters} L`});const r=await _.recent(o,200);u((r.items||[]).slice().reverse())}catch(s){const r=s instanceof Error?s.message:String(s);d({title:"Capture failed",description:r})}finally{v(!1)}},b=n.useMemo(()=>{const s=l.map(i=>i.ts),r=l.map(i=>Number(i.moisture_pct??0)),h=l.map(i=>Number(i.ph??0)),c=l.map(i=>Number(i.temperature_c??0)),Z=l.map(i=>Number(i.ec_dS_m??0));return{ts:s,moisture:r,ph:h,temp:c,ec:Z}},[l]);return e.jsxs("div",{className:"container mx-auto p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsx("h1",{className:"text-2xl font-semibold",children:t("live_farm_stats")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:`text-sm ${a===!1?"text-red-600":a===!0?"text-green-600":"text-muted-foreground"}`,children:[t("edge_label"),": ",a===null?"â€¦":t(a?"connected":"unavailable")]}),e.jsxs(O,{value:o,onValueChange:x,children:[e.jsx(R,{className:"w-32",children:e.jsx(V,{placeholder:t("zone_label")})}),e.jsxs(B,{children:[e.jsx(E,{value:"Z1",children:"Z1"}),e.jsx(E,{value:"Z2",children:"Z2"}),e.jsx(E,{value:"Z3",children:"Z3"})]})]}),e.jsx(M,{disabled:m||a===!1,onClick:k,children:t(m?"capturing":"capture_now")})]})]}),f&&e.jsx("div",{className:"text-sm text-red-600",children:f}),e.jsxs($,{defaultValue:"moisture",className:"w-full",children:[e.jsxs(z,{children:[e.jsx(N,{value:"moisture",children:t("moisture_pct")}),e.jsx(N,{value:"ph",children:t("soil_ph")}),e.jsx(N,{value:"temp",children:t("temperature_c")}),e.jsx(N,{value:"ec",children:t("ec_ds_m")})]}),e.jsx(w,{value:"moisture",children:e.jsx(p,{className:"p-4",children:e.jsx(S,{points:b.moisture,color:"#0ea5e9"})})}),e.jsx(w,{value:"ph",children:e.jsx(p,{className:"p-4",children:e.jsx(S,{points:b.ph,color:"#a855f7"})})}),e.jsx(w,{value:"temp",children:e.jsx(p,{className:"p-4",children:e.jsx(S,{points:b.temp,color:"#ef4444"})})}),e.jsx(w,{value:"ec",children:e.jsx(p,{className:"p-4",children:e.jsx(S,{points:b.ec,color:"#16a34a"})})})]}),e.jsx(p,{className:"p-4",children:e.jsx("div",{className:"text-sm text-muted-foreground",children:"These live graphs help showcase reduced water usage and fertilizer needs over time as soil moisture stabilizes and pH stays in the optimal band."})})]})}export{D as default};
